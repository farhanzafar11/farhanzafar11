terraform {
  required_providers {
    vcd = {
      source  = "vmware/vcd"
      version = "~> 3"
    }
  }
  required_version = ">= 1.0.0"
}

provider "vcd" {
  url          = var.url
  organization = var.organization
  user         = var.user
  password     = var.password
  vdc          = var.vdc
}

variable "url" {
  description = "The vCloud Director API URL"
  type        = string
}

variable "organization" {
  description = "The vCloud Director organization name"
  type        = string
}

variable "user" {
  description = "The vCloud Director user"
  type        = string
}

variable "password" {
  description = "The vCloud Director password"
  type        = string
  sensitive   = true
}

variable "vdc" {
  description = "The vCloud Director Virtual Datacenter (VDC) name"
  type        = string
}

variable "form_mode" {
  description = "The mode of the form submission"
  type        = string
  default     = "terraform"
}

variable "submitted_at" {
  description = "Timestamp of when the form was submitted"
  type        = string
  default     = ""
}

variable "prompt" {
  description = "The original prompt used to generate this Terraform"
  type        = string
  default     = "create me a vm"
}

variable "catalog_name" {
  description = "The catalog name where the VM template resides"
  type        = string
  default     = "default-catalog"
}

variable "template_name" {
  description = "The name of the VM template to deploy"
  type        = string
  default     = "ubuntu-20.04-template"
}

variable "default_network_name" {
  description = "The name of the default network to connect the VM to"
  type        = string
  default     = "default-network"
}

variable "vm_name_prefix" {
  description = "Prefix for the VM name(s)"
  type        = string
  default     = "default-vm"
}

variable "vm_cpu" {
  description = "Number of virtual CPUs for the VM"
  type        = number
  default     = 2
}

variable "vm_memory_mb" {
  description = "Memory in MB for the VM"
  type        = number
  default     = 2048
}

variable "vm_primary_disk_gb" {
  description = "Size of the primary disk in GB for the VM"
  type        = number
  default     = 40
}

variable "tags" {
  description = "A map of tags to apply to the VM"
  type        = map(string)
  default     = {}
}

variable "count" {
  description = "Number of VMs to create"
  type        = number
  default     = 1
}

variable "extra_disks" {
  description = "A list of additional disks to attach to the VM"
  type = list(object({
    size_gb  = number
    bus_type = string
  }))
  default = []
}

variable "static_ip" {
  description = "Optional static IP address for the VM"
  type        = string
  default     = ""
}

resource "vcd_vm" "vm_instance" {
  count             = var.count
  name              = "${var.vdc}-${var.vm_name_prefix}-${count.index + 1}"
  catalog_name      = var.catalog_name
  template_name     = var.template_name
  power_on          = true
  cpu               = var.vm_cpu
  memory            = var.vm_memory_mb
  network_name      = var.default_network_name
  ip_allocation_mode = var.static_ip != "" ? "STATIC" : "DHCP"
  ip_address        = var.static_ip != "" ? var.static_ip : null

  override_template_disk {
    bus_type = "SCSI"
    unit_number = 0
    size_in_mb = var.vm_primary_disk_gb * 1024
  }

  dynamic "disk" {
    for_each = var.extra_disks
    content {
      size_in_mb = disk.value.size_gb * 1024
      bus_type   = disk.value.bus_type
    }
  }

  metadata = var.tags

  lifecycle {
    ignore_changes = [
      vapp_name,
    ]
  }
}

output "vm_names" {
  description = "Names of the provisioned VMs"
  value       = vcd_vm.vm_instance[*].name
}

output "vm_ids" {
  description = "IDs of the provisioned VMs"
  value       = vcd_vm.vm_instance[*].id
}

output "vm_primary_ips" {
  description = "Primary IP addresses of the provisioned VMs"
  value       = vcd_vm.vm_instance[*].network_adapter.0.ip_address
}

output "vcd_org" {
  description = "The vCloud Director organization"
  value       = var.organization
}

output "vdc" {
  description = "The vCloud Director VDC"
  value       = var.vdc
}

output "provided_prompt" {
  description = "The prompt used for generation"
  value       = var.prompt
}

output "form_mode" {
  description = "The form mode"
  value       = var.form_mode
}

output "submitted_at" {
  description = "Timestamp of submission"
  value       = var.submitted_at
}
